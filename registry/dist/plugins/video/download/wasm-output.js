!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["video/download/wasm-output"]=e():t["video/download/wasm-output"]=e()}(globalThis,(()=>(()=>{"use strict";var t={959:(t,e,o)=>{o.r(e),o.d(e,{default:()=>l});var n=function(){var t=this,e=t._self._c;t._self._setupProxy;return t.shouldShow?e("div",{staticClass:"download-video-config-item",staticStyle:{"flex-wrap":"wrap"}},[e("div",{staticClass:"download-video-config-title"},[t._v("写入元数据：")]),t._v(" "),e("SwitchBox",{on:{change:t.saveOptions},model:{value:t.muxWithMetadata,callback:function(e){t.muxWithMetadata=e},expression:"muxWithMetadata"}}),t._v(" "),e("div",{staticClass:"download-video-config-description",staticStyle:{width:"100%"}},[t._v("\n    仅支持元数据类型「ffmetadata」\n  ")])],1):t._e()};n._withStripped=!0;const a=coreApis.ui;var i=o(905);const{options:s}=(0,i.getComponentSettings)("downloadVideo"),r={muxWithMetadata:!1,...s};var c=function(t,e,o,n,a,i,s,r){var c,l="function"==typeof t?t.options:t;if(e&&(l.render=e,l.staticRenderFns=o,l._compiled=!0),n&&(l.functional=!0),i&&(l._scopeId="data-v-"+i),s?(c=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),a&&a.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(s)},l._ssrRegister=c):a&&(c=r?function(){a.call(this,(l.functional?this.parent:this).$root.$options.shadowRoot)}:a),c)if(l.functional){l._injectStyles=c;var d=l.render;l.render=function(t,e){return c.call(e),d(t,e)}}else{var u=l.beforeCreate;l.beforeCreate=u?[].concat(u,c):[c]}return{exports:t,options:l}}(Vue.extend({components:{SwitchBox:a.SwitchBox},data(){const t=(0,i.isComponentEnabled)("saveVideoMetadata");return{shouldShow:t,muxWithMetadata:t&&r.muxWithMetadata}},methods:{saveOptions(){r.muxWithMetadata=this.muxWithMetadata,Object.assign(s,r)}}}),n,[],!1,null,null,null);const l=c.exports},905:t=>{t.exports=coreApis.settings}},e={};function o(n){var a=e[n];if(void 0!==a)return a.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,o),i.exports}o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};o.d(n,{plugin:()=>T,D:()=>j});const a=coreApis.toast,i=coreApis.download,s=coreApis.meta;var r=o(905);const c=coreApis.utils.formatters;function l(t,e,o){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var n=o.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function d(t,e,o){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.set(t,o)}function u(t,e,o){return t.set(p(t,e),o),o}function f(t,e){return t.get(p(t,e))}function p(t,e,o){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:o;throw new TypeError("Private element is not present on this object")}
/* eslint-disable @typescript-eslint/naming-convention */const h=(()=>{let t=0;return()=>t++})();var m=function(t){return t.LOAD="LOAD",t.EXEC="EXEC",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.ERROR="ERROR",t.PROGRESS="PROGRESS",t}(m||{}),w=new WeakMap,g=new WeakMap,v=new WeakMap,E=new WeakMap,y=new WeakMap,b=new WeakMap;const x=coreApis.runtimeLibrary,S={cache:"cache"};async function _(t,e){return async function(){return new Promise(((t,e)=>{const o=unsafeWindow.indexedDB.open("bilibili-evolved-wasm-output",124);o.onerror=e,o.onupgradeneeded=()=>{const t=o.result;for(const e of t.objectStoreNames)t.deleteObjectStore(e);Object.values(S).forEach((e=>{t.createObjectStore(e)}))},o.onsuccess=()=>t(o.result)}))}().then((o=>new Promise(((n,a)=>{const i=o.transaction(t,e);n(i.objectStore(t)),i.onerror=a}))))}async function F(t,e,o){const n=await _(t).then((t=>async function(t,e){return new Promise(((o,n)=>{const a=t.get(e);a.onerror=n,a.onsuccess=()=>o(a.result)}))}(t,e)));if(n)return n;const a=await o(e);return await _(t,"readwrite").then((t=>async function(t,e,o){return new Promise(((n,a)=>{const i=t.put(e,o);i.onerror=a,i.onsuccess=()=>n(i.result)}))}(t,a,e))),a}function R(t){const e=[];return(o,n)=>(a,i,s)=>{e[o]=`${n}: ${function(t,e,o){const n=(0,c.formatFileSize)(t),a=e>0?` / ${(0,c.formatFileSize)(e)}`:"",i=e>0?` @ ${(0,c.formatPercent)(t/e)}`:"";let s="",r="";return e>t&&o>0&&(r=` (${(0,c.formatFileSize)(o)}/s)`,s=` - ${(0,c.formatDuration)((e-t)/o)}`),`${n}${a}${i}${r}${s}`}(a,i,s)}`,t.message=e.join("\n")}}function L(t){return t.headers.get("Content-Encoding")?-1:parseInt(t.headers.get("Content-Length"))}async function $(t,e){const o=await fetch(t);if(!o.ok)throw new Error(`${o.status} ${o.statusText}`);const n=o.body.getReader(),a=L(o);let i=0;const s=[];let r=Date.now(),c=0,l=0;
// eslint-disable-next-line no-constant-condition
for(;;){const{done:t,value:o}=await n.read();if(t)break;s.push(o),i+=o.length;const d=Date.now(),u=(d-r)/1e3;if(u>1){const t=(i-c)/u;e(i,a,t),r=d,c=i,l=t}else e(i,a,c>0?l:0)}const d=new Uint8Array(i);let u=0;for(const t of s)d.set(t,u),u+=t.length;return d}async function A(t){try{const e=await fetch(t,{method:"HEAD"});return e.ok?L(e):-1}catch(t){return-1}}async function M(t,e,o){return F(S.cache,t,(async()=>{const t=await $(e.url,o),n=await x.RuntimeLibrary.sha256(t);if(n!==e.sha256)throw new Error(`Check integrity failed from ${e.url}, expected = ${e.sha256}, actual = ${n}`);return t}))}function P(t,e){const o=new Blob([t],{type:e});return URL.createObjectURL(o)}const W=new class{constructor(){var t=this;d(this,w,null),d(this,g,{}),d(this,v,{}),d(this,E,void 0),l(this,"loaded",!1),d(this,y,(()=>{f(w,this)&&(f(w,this).onmessage=t=>{let{data:{id:e,type:o,data:n}}=t;switch(o){case m.LOAD:this.loaded=!0,f(g,this)[e](n);break;case m.EXEC:case m.WRITE_FILE:case m.READ_FILE:case m.DELETE_FILE:f(g,this)[e](n);break;case m.PROGRESS:f(E,this)&&f(E,this).call(this,n);break;case m.ERROR:f(v,this)[e](n)}delete f(g,this)[e],delete f(v,this)[e]})})),d(this,b,(function(e){let{type:o,data:n}=e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;return f(w,t)?new Promise(((e,s)=>{const r=h();f(w,t)&&f(w,t).postMessage({id:r,type:o,data:n},a),f(g,t)[r]=e,f(v,t)[r]=s,i?.addEventListener("abort",(()=>{s(new DOMException(`Message # ${r} was aborted`,"AbortError"))}),{once:!0})})):Promise.reject(new Error("FFmpeg is not loaded"))})),l(this,"load",((t,e)=>(f(w,this)||(u(w,this,new Worker(t.workerLoadURL,{type:"classic"})),f(y,this).call(this)),f(b,this).call(this,{type:m.LOAD,data:t},void 0,e)))),l(this,"exec",(function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2?arguments[2]:void 0;return f(b,t).call(t,{type:m.EXEC,data:{args:e,timeout:o}},void 0,n)})),l(this,"terminate",(()=>{const t=Object.keys(f(v,this));for(const e of t)f(v,this)[e](new Error("FFmpeg terminated")),delete f(v,this)[e],delete f(g,this)[e];f(w,this)&&(f(w,this).terminate(),u(w,this,null),this.loaded=!1)})),l(this,"writeFile",((t,e,o)=>{const n=[];return n.push(e.buffer),f(b,this).call(this,{type:m.WRITE_FILE,data:{path:t,data:e}},n,o)})),l(this,"readFile",((t,e)=>f(b,this).call(this,{type:m.READ_FILE,data:{path:t,encoding:"binary"}},void 0,e))),l(this,"deleteFile",((t,e)=>f(b,this).call(this,{type:m.DELETE_FILE,data:{path:t}},void 0,e)))}onProgress(t){u(E,this,t)}};async function k(t,e,o,n,s){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const d=a.Toast.info("",`${j} - ${r} / ${l}`),u=R(d),[f,p]=await Promise.all([$(e,u(0,"正在下载视频流")),$(o,u(1,"正在下载音频流"))]);await W.writeFile("video",f),await W.writeFile("audio",p);const h=["-i","video","-i","audio"];n&&(await W.writeFile("ffmetadata",(new TextEncoder).encode(n)),h.push("-i","ffmetadata","-map_metadata","2"),s||h.push("-movflags","+use_metadata_tags")),h.push("-codec","copy","-f",s?"matroska":"mp4","output"),console.debug("FFmpeg commandline args:",h.join(" ")),W.onProgress((t=>{d.message=`混流中: ${(0,c.formatPercent)(t.progress)}`})),await W.exec(h);const m=await W.readFile("output"),w=new Blob([m],{type:s?"video/x-matroska":"video/mp4"});d.message="完成！",d.duration=1e3,await Promise.all([W.deleteFile("video"),W.deleteFile("audio"),W.deleteFile("output"),n?W.deleteFile("ffmetadata"):Promise.resolve()]),await i.DownloadPackage.single(t.replace(/.[^/.]+$/,"."+(s?"mkv":"mp4")),w)}async function O(t,e){W.loaded||await async function(){const t=a.Toast.info("正在加载 FFmpeg",`${j} - 初始化`),e=R(t),[o,n,i]=await Promise.all([M("ffmpeg-worker",s.meta.compilationInfo.altCdn.library.ffmpeg.worker,e(0,"正在加载 FFmpeg Worker")),M("ffmpeg-core",s.meta.compilationInfo.altCdn.library.ffmpeg.core,e(1,"正在加载 FFmpeg Core")),M("ffmpeg-wasm",s.meta.compilationInfo.altCdn.library.ffmpeg.wasm,e(2,"正在加载 FFmpeg WASM"))]);await W.load({workerLoadURL:P(o,"text/javascript"),coreURL:P(n,"text/javascript"),wasmURL:P(i,"application/wasm")}),t.message="完成！",t.close()}();const{infos:o,extraAssets:n}=t;let i;if(e){const e=[];for(const{asset:t,instance:a}of n)i||"saveVideoMetadata"!==t.name||"ffmetadata"!==a.type?e.push({asset:t,instance:a}):i=await t.getAssets(o,a);t.extraAssets=e}const{dashAudioExtension:l,dashFlacAudioExtension:d,dashVideoExtension:u}=(0,r.getComponentSettings)("downloadVideo").options;for(let t=0;t<o.length;t++){const e=o[t],[n,a]=e.titledFragments;if(2!==e.fragments.length||n.extension!==u||a.extension!==l&&a.extension!==d)throw new Error("仅支持 DASH 格式视频和音频");const[s,r]=await Promise.all([A(n.url),A(a.url)]),f=Math.max(s,n.size)+Math.max(r,a.size);if(f>2097152e3)throw new Error(`仅支持合并 2GB 内的音视频（${(0,c.formatFileSize)(f)}）`);await k(n.title,n.url,a.url,i?.[t]?.data,a.extension===d,t+1,o.length)}}const j="WASM 混流输出",C="使用 WASM 在浏览器中下载并合并音视频, 支持批量下载",T={name:"downloadVideo.outputs.wasm",displayName:`下载视频 - ${j}`,description:C,author:{name:"WakelessSloth56",link:"https://github.com/WakelessSloth56"},setup:t=>{let{addData:e}=t;e("downloadVideo.outputs",(t=>{t.push({name:"wasm",displayName:"WASM",description:`${C}。运行过程中请勿关闭页面，初次使用或清除缓存后需要加载约 30 MB 的 WASM 文件。由于浏览器限制，仅支持合并 2GB 以内的音视频。`,runAction:async(t,e)=>{try{await O(t,e.muxWithMetadata)}catch(t){a.Toast.error(String(t),j)}},component:()=>Promise.resolve().then(o.bind(o,959)).then((t=>t.default))})}))},commitHash:"e834154923961e2f2a04cdc357c836cb2fcf8610",coreVersion:"2.10.2"};return n=n.plugin})()));